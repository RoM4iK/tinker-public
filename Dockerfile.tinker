# Tinker Agent Sandbox
# Downloads skills and agent-bridge from tinker-public at build time

FROM ubuntu:24.04

ARG USER_ID=1000
ARG GROUP_ID=1000
ARG TINKER_PUBLIC_URL=https://raw.githubusercontent.com/RoM4iK/tinker-public/main

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    gh \
    sudo \
    tmux \
    nodejs \
    npm \
    jq \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create claude user with matching UID/GID
RUN groupadd -g ${GROUP_ID} claude 2>/dev/null || true && \
    useradd -m -u ${USER_ID} -g ${GROUP_ID} -s /bin/bash claude && \
    echo "claude ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install Claude CLI
RUN npm install -g @anthropic-ai/claude-code

# Download agent-bridge binary
RUN curl -fsSL ${TINKER_PUBLIC_URL}/bin/agent-bridge -o /usr/local/bin/agent-bridge && \
    chmod +x /usr/local/bin/agent-bridge

# Download agent-bridge-tmux wrapper (if exists, otherwise create simple one)
RUN curl -fsSL ${TINKER_PUBLIC_URL}/bin/agent-bridge-tmux -o /usr/local/bin/agent-bridge-tmux 2>/dev/null || \
    echo '#!/bin/bash\nexec tmux new-session -s agent "agent-bridge"' > /usr/local/bin/agent-bridge-tmux && \
    chmod +x /usr/local/bin/agent-bridge-tmux

# Download skills
RUN mkdir -p /opt/tinker/skills && \
    for skill in git-workflow memory memory-consolidation orchestrator-workflow \
                 proposal-execution researcher-workflow retrospective \
                 review-workflow ticket-management worker-workflow; do \
        mkdir -p /opt/tinker/skills/$skill && \
        curl -fsSL ${TINKER_PUBLIC_URL}/skills/$skill/SKILL.md \
            -o /opt/tinker/skills/$skill/SKILL.md 2>/dev/null || true; \
    done

# Create workspace directory
RUN mkdir -p /workspace && chown claude:claude /workspace

# Copy project files (done at runtime, but prepare directory)
WORKDIR /workspace

# Switch to claude user
USER claude

# Setup Claude config directory
RUN mkdir -p /home/claude/.claude

# Entrypoint script to setup environment
RUN cat > /home/claude/entrypoint.sh << 'ENTRY' && chmod +x /home/claude/entrypoint.sh
#!/bin/bash
set -e

# Copy Claude config if mounted
if [ -f /tmp/cfg/claude.json ]; then
    cp /tmp/cfg/claude.json /home/claude/.claude.json 2>/dev/null || true
fi
if [ -d /tmp/cfg/claude_dir ]; then
    cp -r /tmp/cfg/claude_dir/* /home/claude/.claude/ 2>/dev/null || true
fi

# Copy GitHub App private key if mounted
if [ -f /tmp/github-app-privkey.pem ]; then
    cp /tmp/github-app-privkey.pem /home/claude/.github-app-privkey.pem
    chmod 600 /home/claude/.github-app-privkey.pem
fi

# Setup skills symlink
mkdir -p /workspace/.claude
ln -sf /opt/tinker/skills /workspace/.claude/skills 2>/dev/null || true

# Setup git if remote configured
if [ -n "$GIT_REMOTE_URL" ] && [ -d "/workspace/.git" ]; then
    cd /workspace
    git config --global --add safe.directory /workspace
    
    if [ -n "$GH_TOKEN" ]; then
        git config --global credential.helper store
        git config --global url."https://${GH_TOKEN}@github.com/".insteadOf "https://github.com/"
    fi
fi

exec "$@"
ENTRY

ENTRYPOINT ["/home/claude/entrypoint.sh"]
CMD ["agent-bridge"]
