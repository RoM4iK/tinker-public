#!/bin/bash
# Skill Hook Template: Knowledge Injection for Specific Skills
#
# This template demonstrates how to fetch skill-specific knowledge hints
# when a skill is invoked by Claude.
#
# Usage:
# 1. Copy this template to your skill directory: hooks/skill-hooks/<skill-name>.sh
# 2. Replace SKILL_NAME with your actual skill name
# 3. Make the script executable: chmod +x hooks/skill-hooks/<skill-name>.sh
# 4. Configure Claude to invoke this hook when the skill is loaded
#
# Environment Variables Required:
#   PROJECT_ID     - Your Tinker project ID
#   RAILS_API_URL  - API URL (e.g., https://tinker.example.com/api/v1)
#   RAILS_API_KEY  - MCP API key for authentication

set -e

# ===== CONFIGURATION =====
# Replace SKILL_NAME with your actual skill name (e.g., "git-workflow", "worker-workflow")
SKILL_NAME="{{SKILL_NAME}}"
# ========================

# Validate required environment variables
if [[ -z "${PROJECT_ID}" ]]; then
  echo "# Warning: PROJECT_ID not set, skipping skill knowledge injection" >&2
  exit 0
fi

if [[ -z "${RAILS_API_URL}" ]]; then
  echo "# Warning: RAILS_API_URL not set, skipping skill knowledge injection" >&2
  exit 0
fi

if [[ -z "${RAILS_API_KEY}" ]]; then
  echo "# Warning: RAILS_API_KEY not set, skipping skill knowledge injection" >&2
  exit 0
fi

# Construct API endpoint URL
API_ENDPOINT="${RAILS_API_URL}/internal/knowledge/skill_hint"
QUERY_PARAMS="skill_name=${SKILL_NAME}&project_id=${PROJECT_ID}"

# Fetch skill hint knowledge from Rails API
if response=$(curl -s \
  --fail \
  --header "X-API-Key: ${RAILS_API_KEY}" \
  --header "Accept: text/plain" \
  "${API_ENDPOINT}?${QUERY_PARAMS}"); then

  # Only output if we got content
  if [[ -n "${response}" ]]; then
    cat <<EOF

# Skill-Specific Knowledge: ${SKILL_NAME}
${response}

EOF
  fi
else
  # Silently fail - don't break skill loading if API is unavailable
  echo "# Note: Unable to fetch skill hint for ${SKILL_NAME} from ${API_ENDPOINT}" >&2
fi

exit 0
