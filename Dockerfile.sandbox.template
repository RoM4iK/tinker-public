# syntax=docker/dockerfile:1.4
# Tinker Agent Sandbox - Copy to your project as Dockerfile.sandbox
ARG RUBY_VERSION=3.4.1

FROM docker.io/library/ruby:$RUBY_VERSION-slim

# =============================================================================
# System dependencies
# =============================================================================
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
    git curl build-essential ca-certificates gnupg sudo tmux wget jq && \
    rm -rf /var/lib/apt/lists/*

# GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
    | tee /etc/apt/sources.list.d/github-cli.list && \
    apt-get update && apt-get install gh -y && \
    rm -rf /var/lib/apt/lists/*

# Node.js + Claude CLI
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g @anthropic-ai/claude-code

# =============================================================================
# Non-root user with sudo
# =============================================================================
ARG USER_ID=1000
ARG GROUP_ID=1000
RUN if ! getent group ${GROUP_ID} >/dev/null 2>&1; then \
      groupadd -g ${GROUP_ID} claude; \
    else \
      GROUP_NAME=$(getent group ${GROUP_ID} | cut -d: -f1); \
      groupmod -n claude ${GROUP_NAME}; \
    fi && \
    useradd -u ${USER_ID} -g claude -m -s /bin/bash claude && \
    echo "claude ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# =============================================================================
# Download Tinker binaries from GitHub (NOT copied from host)
# =============================================================================
ARG TINKER_VERSION=main
RUN curl -fsSL "https://raw.githubusercontent.com/RoM4iK/tinker-public/${TINKER_VERSION}/bin/agent-bridge" \
    -o /usr/local/bin/agent-bridge && \
    curl -fsSL "https://raw.githubusercontent.com/RoM4iK/tinker-public/${TINKER_VERSION}/bin/agent-bridge-tmux" \
    -o /usr/local/bin/agent-bridge-tmux && \
    chmod +x /usr/local/bin/agent-bridge /usr/local/bin/agent-bridge-tmux

# =============================================================================
# Skills are DOWNLOADED at container start (not in build)
# =============================================================================
# See entrypoint script below - downloads from tinker-public repo

# =============================================================================
# Project-specific setup (CUSTOMIZE THIS SECTION)
# =============================================================================
WORKDIR /app

# Example: Ruby project
# COPY --chown=claude:claude Gemfile Gemfile.lock ./
# RUN bundle install

# Example: Node project
# COPY --chown=claude:claude package.json package-lock.json ./
# RUN npm ci

# =============================================================================
# Copy application code
# =============================================================================
COPY --chown=claude:claude . /app

# =============================================================================
# Git config (overridden by tinker.env.json at runtime)
# =============================================================================
RUN git config --system user.email "tinker-agent@example.com" && \
    git config --system user.name "Tinker Agent" && \
    git config --system --add safe.directory /app

# =============================================================================
# Entrypoint
# =============================================================================
RUN printf '#!/bin/bash\n\
set -e\n\
\n\
# Copy Claude config if mounted\n\
if [ -f "/tmp/cfg/claude.json" ]; then\n\
  cp /tmp/cfg/claude.json /home/claude/.claude.json\n\
fi\n\
if [ -d "/tmp/cfg/claude_dir" ]; then\n\
  rm -rf /home/claude/.claude\n\
  cp -r /tmp/cfg/claude_dir /home/claude/.claude\n\
fi\n\
\n\
# Download skills from tinker-public repo\n\
TINKER_VERSION="${TINKER_VERSION:-main}"\n\
SKILLS_URL="https://github.com/RoM4iK/tinker-public/archive/refs/heads/${TINKER_VERSION}.tar.gz"\n\
echo "Downloading Tinker skills..."\n\
mkdir -p /home/claude/.claude/skills\n\
curl -fsSL "$SKILLS_URL" | tar -xz --strip-components=2 -C /home/claude/.claude/skills "tinker-public-${TINKER_VERSION}/skills"\n\
echo "Skills downloaded."\n\
\n\
# Write CLAUDE.md from mounted banner\n\
if [ -f "/tmp/agent-banner.txt" ]; then\n\
  cp /tmp/agent-banner.txt /app/CLAUDE.md\n\
fi\n\
\n\
# GitHub App key if mounted\n\
if [ -f "/tmp/github-app-privkey.pem" ]; then\n\
  cp /tmp/github-app-privkey.pem /home/claude/.github-app-privkey.pem\n\
  chmod 600 /home/claude/.github-app-privkey.pem\n\
fi\n\
\n\
chown -R claude:claude /home/claude\n\
exec sudo -E -u claude env "HOME=/home/claude" "$@"\n\
' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["agent-bridge-tmux"]
